<?xml version="1.0" encoding="UTF-8"?>

<?define BASE_DIR = ".."?>
<?define SourceAppDir = "$(var.BASE_DIR)\Release"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <?include $(sys.CURRENTDIR)Include1.wxi ?>
	<Product Id="*" Name="fireBwall $(var.VersionNumber)" Language="1033" Version="$(var.VersionNumber)" Manufacturer="bwall" UpgradeCode="$(var.UpgradeCode)">    
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine"/>

    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion OnlyDetect="yes" Minimum="$(var.VersionNumber)" IncludeMinimum="no" Property="NEWER_VERSION_FOUND" />
      <UpgradeVersion Minimum="0.0.0.0" IncludeMinimum="yes" Maximum="$(var.VersionNumber)" IncludeMaximum="no" Property="OLDER_VERSION_FOUND" />
    </Upgrade>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLLOCATION" Name="fireBwall">
          <!-- Auto-start via Registry -->
          <Component Id="firebwallAutostart">
            <RegistryKey Root="HKCU" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run" >
              <RegistryValue Type="string" Name="firebwall" Value="[INSTALLLOCATION]firebwall.exe" Action="write" />
            </RegistryKey>
            <Condition>ASSISTANCE_START_VIA_REGISTRY</Condition>
          </Component>
          <Component Id="cfBwallExe" Guid="C7021A24-C661-4C9C-9C8F-B047E8096298">
            <File Source="..\passthru\bin\Release\fireBwall.exe" KeyPath="yes" Id="fireBwall.exe">
            </File>
          </Component>
          <Component Id="FirewallModuleDll">
            <File Source="..\passthru\bin\Release\FirewallModule.dll" KeyPath="yes" Id="FirewallModule.dll"></File>
          </Component>
          <Component Id="cDrivers">
            <File Source="..\winpkflt_rtl.exe" KeyPath="yes" Id="winpkflt_rtl.exe"></File>
          </Component>
          <Component Id="cndisapi">
            <File Source="..\passthru\bin\Release\ndisapi.dll" KeyPath="yes" Id="apidll"></File>
          </Component>
        </Directory>
      </Directory>
      <!-- Start menu structure -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="fireBwall">
          <Component Id="cStartMenufbwallExe" Guid="1691B12D-6C5D-47EA-A07A-67FDA9519156">
            <Shortcut Id="shortcutStartMenufbwallExe" Name="fireBwall"
                      Target="[INSTALLLOCATION]firebwall.exe" WorkingDirectory="APPLICATIONFOLDER"/>
            <RemoveFolder Id="removeApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall"/>
            <RegistryValue Root="HKCU" Key="Software\bwall\firebwall" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
        </Directory>
      </Directory>
		</Directory>

    <Property Id="ASSISTANCE_START_VIA_REGISTRY">1</Property>    
    
		<Feature Id="ProductFeature" Title="fireBwall" Level="1">
      <ComponentRef Id="firebwallAutostart" />
      <ComponentRef Id="cStartMenufbwallExe" />
			<ComponentRef Id="cfBwallExe" />
      <ComponentRef Id="cDrivers" />
      <ComponentRef Id="cndisapi"/>
      <ComponentRef Id="FirewallModuleDll"/>
		</Feature>

    <Property Id="WixShellExecTarget" Value="[#winpkflt_rtl.exe]" />
    <CustomAction Id="InstallDrivers" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

    <Property Id="ApplicationFolderName" Value="My Application Folder" />
    <Property Id="WixAppFolder" Value="WixPerMachineFolder" />

    <UIRef Id="WixUI_Minimal" />
    <UI>
      <!-- These dialog references are needed for CloseApplication above to work correctly -->
      <DialogRef Id="FilesInUse" />
      <DialogRef Id="MsiRMFilesInUse" />
      <!-- Here we'll add the GUI logic for installation and updating in a future post-->
    </UI>

    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallInitialize"/>
      <Custom Action="WixCloseApplications" Before="InstallInitialize" />
      <Custom Action="InstallDrivers" OnExit="success" />
    </InstallExecuteSequence>
    <util:CloseApplication Id="CloseSuperForm" CloseMessage="no" ElevatedCloseMessage="no" RebootPrompt="no" Target="$(var.ExeProcessName)" />
	</Product>
</Wix>
